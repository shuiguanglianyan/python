<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>devops-cmdb</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header>
      <div>
        <h1>devops-cmdb</h1>
        <p>生产级 DevOps 运维 CMDB（资产 / 服务 / 变更）</p>
      </div>
      <form method="post" action="/logout">
        <button type="submit" class="outline">退出登录</button>
      </form>
    </header>

    <div class="layout">
      <aside class="sidebar card">
        <h2>系统导航</h2>
        <ul class="tree">
          <li>
            <span>总览</span>
            <ul>
              <li><a href="#overview">指标看板</a></li>
              <li><a href="#veops-map">VEOPS 功能全景</a></li>
            </ul>
          </li>
          <li>
            <span>资产管理</span>
            <ul>
              <li><a href="#search-assets">搜索资产</a></li>
              <li><a href="#new-asset">新增资产</a></li>
              <li><a href="#asset-list">资产列表</a></li>
            </ul>
          </li>
          <li>
            <span>服务管理</span>
            <ul>
              <li><a href="#new-service">新增服务</a></li>
              <li><a href="#service-list">服务列表</a></li>
            </ul>
          </li>
          <li>
            <span>变更管理</span>
            <ul>
              <li><a href="#new-change">新增变更</a></li>
              <li><a href="#change-list">变更列表</a></li>
            </ul>
          </li>
          <li>
            <span>平台接口</span>
            <ul>
              <li><a href="#api-section">OpenAPI</a></li>
              <li><a href="#veops-plan">能力补齐计划</a></li>
            </ul>
          </li>
        </ul>
      </aside>

      <main>
        <section class="card" id="overview">
          <h2>指标看板</h2>
          <div class="stats-grid">
            <article>
              <h3>资产总数</h3>
              <p>{{ total_assets }}</p>
            </article>
            <article>
              <h3>服务总数</h3>
              <p>{{ total_services }}</p>
            </article>
            <article>
              <h3>待处理变更</h3>
              <p>{{ pending_changes }}</p>
            </article>
          </div>
        </section>

        <section class="card" id="veops-map">
          <h2>VEOPS CMDB 功能映射</h2>
          <p class="muted">以下模块参考 VEOPS CMDB 的能力面，确保每个功能都在本系统中有体现（已支持 / 部分支持 / 规划中）。</p>
          <div class="feature-groups">
            {% for group in veops_feature_map %}
            <article>
              <h3>{{ group["group"] }}</h3>
              <ul>
                {% for item in group["items"] %}
                <li>
                  <a href="#{{ item.anchor }}">{{ item.name }}</a>
                  <span class="tag {% if item.status == '已支持' %}tag-ok{% elif item.status == '部分支持' %}tag-partial{% else %}tag-plan{% endif %}">{{ item.status }}</span>
                </li>
                {% endfor %}
              </ul>
            </article>
            {% endfor %}
          </div>
        </section>

        <section class="card" id="search-assets">
          <h2>搜索资产</h2>
          <form method="get" action="/" class="grid grid-3">
            <input type="text" name="q" value="{{ q }}" placeholder="按主机/IP/负责人搜索" />
            <select name="status_filter">
              <option value="" {% if not status %}selected{% endif %}>全部状态</option>
              <option value="active" {% if status == 'active' %}selected{% endif %}>active</option>
              <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>inactive</option>
            </select>
            <button type="submit">查询</button>
          </form>
        </section>

        <section class="card" id="new-asset">
          <h2>新增资产</h2>
          <form method="post" action="/assets" class="grid grid-4">
            <input required name="hostname" placeholder="hostname" />
            <input required name="ip" placeholder="ip" />
            <input name="environment" value="prod" placeholder="environment" />
            <input name="os" value="linux" placeholder="os" />
            <input name="owner" placeholder="owner" />
            <input name="status" value="active" placeholder="status" />
            <input class="span-2" name="note" placeholder="note" />
            <button type="submit">添加资产</button>
          </form>
        </section>

        <section class="card" id="new-service">
          <h2>新增服务</h2>
          <form method="post" action="/services" class="grid grid-4">
            <input required name="name" placeholder="service name" />
            <input required name="asset_id" type="number" placeholder="asset id" />
            <input name="repo_url" placeholder="repo url" />
            <input name="deploy_method" value="ansible" placeholder="deploy method" />
            <input name="owner" placeholder="owner" />
            <input name="status" value="running" placeholder="status" />
            <input class="span-2" name="note" placeholder="note" />
            <button type="submit">添加服务</button>
          </form>
        </section>

        <section class="card" id="new-change">
          <h2>新增变更</h2>
          <form method="post" action="/changes" class="grid grid-4">
            <input required name="title" placeholder="change title" class="span-2" />
            <input required name="service_id" type="number" placeholder="service id" />
            <input name="risk_level" value="medium" placeholder="risk" />
            <input name="change_window" placeholder="window" />
            <input name="executor" placeholder="executor" />
            <input name="approver" placeholder="approver" />
            <input name="status" value="pending" placeholder="status" />
            <input class="span-2" name="rollback_plan" placeholder="rollback plan" />
            <button type="submit">添加变更</button>
          </form>
        </section>

        <section class="card" id="asset-list">
          <h2>资产列表</h2>
          <table>
            <thead>
              <tr><th>ID</th><th>Hostname</th><th>IP</th><th>Env</th><th>Owner</th><th>Status</th><th>操作</th></tr>
            </thead>
            <tbody>
              {% for a in assets %}
              <tr>
                <td>{{ a.id }}</td><td>{{ a.hostname }}</td><td>{{ a.ip }}</td><td>{{ a.environment }}</td><td>{{ a.owner }}</td><td>{{ a.status }}</td>
                <td>
                  <form method="post" action="/assets/{{ a.id }}/delete">
                    <button class="danger">删除</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>

        <section class="card" id="service-list">
          <h2>服务列表</h2>
          <table>
            <thead>
              <tr><th>ID</th><th>Name</th><th>AssetID</th><th>Deploy</th><th>Owner</th><th>Status</th><th>操作</th></tr>
            </thead>
            <tbody>
              {% for s in services %}
              <tr>
                <td>{{ s.id }}</td><td>{{ s.name }}</td><td>{{ s.asset_id }}</td><td>{{ s.deploy_method }}</td><td>{{ s.owner }}</td><td>{{ s.status }}</td>
                <td>
                  <form method="post" action="/services/{{ s.id }}/delete">
                    <button class="danger">删除</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>

        <section class="card" id="change-list">
          <h2>变更列表</h2>
          <table>
            <thead>
              <tr><th>ID</th><th>Title</th><th>ServiceID</th><th>Risk</th><th>Executor</th><th>Status</th><th>操作</th></tr>
            </thead>
            <tbody>
              {% for c in changes %}
              <tr>
                <td>{{ c.id }}</td><td>{{ c.title }}</td><td>{{ c.service_id }}</td><td>{{ c.risk_level }}</td><td>{{ c.executor }}</td><td>{{ c.status }}</td>
                <td>
                  <form method="post" action="/changes/{{ c.id }}/delete">
                    <button class="danger">删除</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>

        <section class="card" id="api-section">
          <h2>平台接口</h2>
          <div class="api-links">
            <a href="/docs" target="_blank" rel="noreferrer">Swagger 文档 /docs</a>
            <a href="/openapi.json" target="_blank" rel="noreferrer">OpenAPI /openapi.json</a>
            <a href="/api/overview" target="_blank" rel="noreferrer">总览 API /api/overview</a>
          </div>
        </section>

        <section class="card" id="veops-plan">
          <h2>能力补齐计划（对齐 VEOPS）</h2>
          <ol>
            <li>模型中心：增加模型、属性、关系、约束、生命周期管理。</li>
            <li>关系拓扑：新增服务与资产的可视化拓扑视图。</li>
            <li>审计体系：增加操作日志、变更历史、回收站恢复。</li>
            <li>权限体系：引入 RBAC、多租户、细粒度数据权限。</li>
            <li>自动化：引入审批流、任务编排、Webhook 同步。</li>
          </ol>
        </section>
      </main>
    </div>
  </body>
</html>
